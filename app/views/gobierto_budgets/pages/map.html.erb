<% content_for(:header) do %>
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

  <style>
.CDB-Tooltip--isDark.CDB-Tooltip {
    background: #2E3C43
}

.CDB-Tooltip--isDark .CDB-Tooltip-listTitle {
    color: rgba(255, 255, 255, 0.64)
}

.CDB-Tooltip--isDark .CDB-Tooltip-listText {
    color: #FFF
}

.CDB-Tooltip--isLight.CDB-Tooltip {
    background: #FFF
}

.CDB-Tooltip--isLight .CDB-Tooltip-listTitle {
    color: #636D72
}

.CDB-Tooltip-wrapper {
    display: none;
    position: absolute;
    min-width: 120px;
    max-width: 180px;
    border-radius: 4px;
    overflow: hidden
}

.CDB-Tooltip-wrapper.CDB-Tooltip-wrapper--topLeft {
    border-top-left-radius: 0
}

.CDB-Tooltip-wrapper.CDB-Tooltip-wrapper--topRight {
    border-top-right-radius: 0
}

.CDB-Tooltip-wrapper.CDB-Tooltip-wrapper--bottomLeft {
    border-bottom-left-radius: 0
}

.CDB-Tooltip-wrapper.CDB-Tooltip-wrapper--bottomRight {
    border-bottom-right-radius: 0
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper {
    padding: 20px 24px;
    background: #FFF;
    font-family: 'Open Sans';
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.05);
    z-index: 50
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper.dark {
    background: #2E3C43;
    color: #FFF
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper.dark h4 {
    color: rgba(255, 255, 255, 0.64)
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper h4 {
    margin-top: 8px;
    color: #636D72;
    font-size: 10px;
    font-weight: 400;
    line-height: 15px;
    text-transform: uppercase
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper h4:first-child {
    margin-top: 0
}

.CDB-Tooltip-wrapper .cartodb-tooltip-content-wrapper p {
    font-size: 12px;
    font-weight: 600;
    line-height: 16px
}

.CDB-Tooltip {
    padding: 20px 24px;
    font-family: 'Open Sans';
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.05);
    z-index: 50
}

.CDB-Tooltip-listItem {
    margin-top: 8px
}

.CDB-Tooltip-listItem:first-child {
    margin-top: 0
}

.CDB-Tooltip-listTitle {
    font-size: 10px;
    font-weight: 400;
    line-height: 15px;
    text-transform: uppercase
}

.CDB-Tooltip-listText {
    font-size: 12px;
    font-weight: 600;
    line-height: 16px
}
  </style>

<% end %>

<%
  @title = t('.title', year: @year)
  set_meta_tags title: @title
  set_meta_tags description: t('.meta_description', year: @year)
%>

<header class="place">
  <div class="tools_cont">
    <div class="tools sticky">
    </div>
  </div>

  <h1 title="<%= t('.municipality_maps') %>">
    <%= render partial: 'gobierto_budgets/places/year_switcher' %>
    <%= t('.municipality_maps') %>
  </h1>

  <div class="share_links">
    <%= link_to '<i class="fa fa-twitter"></i>'.html_safe, "https://twitter.com/home?status=#{u twitter_share(@title || @share_text, request.original_url)}", class: 'small_button popup', data: {rel: 'Twitter'} %>
    <%= link_to '<i class="fa fa-facebook"></i>'.html_safe, "http://www.facebook.com/sharer/sharer.php?u=#{u request.original_url}", class: 'small_button popup', data: {rel: 'Facebook'} %>
  </div>
</header>

<%= render partial: 'map_metrics' %>

<div class="map_sidebar" data-budget-line-categories-tree>
  <div class="sidebar_wrapper">

    <div class="switcher year_switcher">
      <h2 class="sidebar_title"></h2>
      <ul>
        <li><a href="#" data-select-category data-area="<%= GobiertoBudgets::BudgetLine::ECONOMIC %>"   data-kind="<%= GobiertoBudgets::BudgetLine::INCOME %>"  data-api-url="<%= gobierto_budgets_api_categories_path(area: GobiertoBudgets::BudgetLine::ECONOMIC, kind: GobiertoBudgets::BudgetLine::INCOME, format: :json) %>">Ingresos</a></li>
        <li><a href="#" data-select-category data-area="<%= GobiertoBudgets::BudgetLine::FUNCTIONAL %>" data-kind="<%= GobiertoBudgets::BudgetLine::EXPENSE %>" data-selected data-api-url="<%= gobierto_budgets_api_categories_path(area: GobiertoBudgets::BudgetLine::FUNCTIONAL, kind: GobiertoBudgets::BudgetLine::EXPENSE, format: :json) %>">En qué se gasta</a></li>
        <li><a href="#" data-select-category data-area="<%= GobiertoBudgets::BudgetLine::ECONOMIC %>"   data-kind="<%= GobiertoBudgets::BudgetLine::EXPENSE %>" data-api-url="<%= gobierto_budgets_api_categories_path(area: GobiertoBudgets::BudgetLine::ECONOMIC, kind: GobiertoBudgets::BudgetLine::EXPENSE, format: :json) %>">Para qué se gasta</a></li>
      </ul>
    </div>

    <i class="icon_sidebar fa fa-caret-square-o-up pull-right" aria-hidden="true" data-toggle></i>

    <div class="items">
      <table>
        <tr data-search-box>
          <th>
            <input type="text" placeholder="<%= t('.search') %>" class="search_items">
          </th>
        </tr>
      </table>
    </div>
  </div>
</div>

<div id="map"></div>

<% content_for(:javascript) do %>
$(function () {
CSS['gasto_por_habitante'] = "\
#indicators_2016 [ value <= 700]  { polygon-fill: #d73027; }\
#indicators_2016 [ value > 700]   { polygon-fill: #f79272; }\
#indicators_2016 [ value > 1200]  { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 1500]  { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 3000 ] { polygon-fill: #1a9850; }\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
";

CSS['gasto_total'] = "\
#indicators_2016 [ value <= 700000] { polygon-fill: #d73027; }\
#indicators_2016 [ value >  700000] { polygon-fill: #f79272; }\
#indicators_2016 [ value > 1200000] { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 1500000] { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 3000000] { polygon-fill: #1a9850; }\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
";

CSS['budgets'] = "\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
#indicators_2016 [ value <=  10]  { polygon-fill: #d73027; }\
#indicators_2016 [ value >   10]  { polygon-fill: #f79272; }\
#indicators_2016 [ value >  800]  { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 1500] { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 3000] { polygon-fill: #1a9850; }\
";

CSS['planned_vs_executed'] = "\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
#indicators_2016 [ value <= 100000]  { polygon-fill: #d73027; }\
#indicators_2016 [ value >  100000]  { polygon-fill: #f79272; }\
#indicators_2016 [ value > 8000000]  { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 15000000] { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 30000000] { polygon-fill: #1a9850; }\
";

CSS['population'] = "\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
#indicators_2016 [ value <= 1000]   { polygon-fill: #d73027; }\
#indicators_2016 [ value >  1000]    { polygon-fill: #f79272; }\
#indicators_2016 [ value > 10000]   { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 100000]  { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 1000000] { polygon-fill: #1a9850; }\
";

CSS['debt'] = "\
#indicators_2016 [ value = 0]  { polygon-fill: #ffffff; }\
#indicators_2016 [ value <= 1000]   { polygon-fill: #d73027; }\
#indicators_2016 [ value >  1000]    { polygon-fill: #f79272; }\
#indicators_2016 [ value > 10000]   { polygon-fill: #fff2cc; }\
#indicators_2016 [ value > 100000]  { polygon-fill: #8cce8a; }\
#indicators_2016 [ value > 1000000] { polygon-fill: #1a9850; }\
";

  function renderMapIndicator(layer, vis){
    $('[data-indicator]').click(function(e){
      var year = $('body').data('year');
      var indicator = $('.metric.selected').data('indicator');
      layer.show();

      var query = "select i.cartodb_id, t.place_id, t.nameunit as name, t.the_geom, t.the_geom_webmercator, i."+indicator+" as value from ign_spanish_adm3_municipalities_displaced_canary as t full join indicators_"+year+" as i on i.place_id = t.place_id";
      console.log(query);
      layer.setSQL(query);

      var css = CSS[indicator];
      layer.setCartoCSS(css);
      // $('#legend').html($('#legend_' + indicator).html());
    });
  }

  function renderMapBudgetLine(layer, vis){
    $(document).on('renderBudgetLineCategory', function(e){
      $('.metric').removeClass('selected');
      var year = $('body').data('year');

      layer.show();

      var query = "select i.cartodb_id, t.place_id, t.nameunit as name, t.the_geom, t.the_geom_webmercator, i.code, i.kind, i.area, i.amount, i.amount_per_inhabitant as value from ign_spanish_adm3_municipalities_displaced_canary as t full join planned_budgets_"+year+" as i on i.place_id = t.place_id" +
      " WHERE code='"+e.code+"' AND kind='" + e.kind + "' AND area='" + e.area[0] + "'";
      console.log(query);
      layer.setSQL(query);

      var css = CSS['budgets'];
      layer.setCartoCSS(css);
      // $('#legend').html($('#legend_' + indicator).html());
    });
  }

  var breakpoint = 770;

  if($(window).width() >= breakpoint) {
    var home_map_zoom_level = 6;
    var home_map_center_lat = 39.3;
    var home_map_center_lon = -5.6;
  }
  else {
    var home_map_zoom_level = 5;
    var home_map_center_lat = 38.3;
    var home_map_center_lon = -4.0;
  }

  cartodb.createVis('map', 'https://gobierto.carto.com/api/v2/viz/205616b2-b893-11e6-b070-0e233c30368f/viz.json', {
    shareable: false,
    title: false,
    description: false,
    search: false,
    tiles_loader: true,
    center_lat: home_map_center_lat,
    center_lon: home_map_center_lon,
    zoom: home_map_zoom_level,
    zoomControl: true,
    loaderControl: false
  })
  .done(function(vis, layers) {
    var sublayer = layers[1].getSubLayer(0);
    vis.addOverlay({
      type: 'tooltip',
      layer: sublayer,
      template: $('#infowindow_template').html(),
      position: 'bottom|right',
      fields: [{ name: 'name', value: 'value' }]
    });
    sublayer.setInteractivity('name, value');
    renderMapIndicator(sublayer, vis);
    renderMapBudgetLine(sublayer, vis);
    $('[data-indicator].selected').click();
  })
  .error(function(err) {
    console.log(err);
  });

  $('.metric').on('click', function(e){
    e.preventDefault();
    $('.metric').removeClass('selected');
    $(this).addClass('selected');
  });
});
<% end %>

<script type="infowindow/html" id="infowindow_template">
<div class="CDB-Tooltip CDB-Tooltip--isLight">
  <ul class="CDB-Tooltip-list">
    <li class="CDB-Tooltip-listItem">
      <h4 class="CDB-Tooltip-listText">{{name}}</h4>
      <h4 class="CDB-Tooltip-listText">{{value}}</h4>
    </li>
  </ul>
</div>
</script>
